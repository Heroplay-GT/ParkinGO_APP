<ion-content class="ingreso-page" fullscreen="true">

  <div class="header">
    <h1>Vehicle Entry</h1>
    <p>Manage incoming vehicles</p>
  </div>

  <div class="actions-row">

    <!-- Botón Scan QR -->
    <ion-button class="scan-btn" (click)="openScannerPage()">
      <ion-icon name="qr-code-outline"></ion-icon>
    </ion-button>

    <!-- Botón ingresar sin reserva -->
    <ion-button class="manual-btn" (click)="openManualEntryModal()">
      <ion-icon name="add-circle-outline" slot="start"></ion-icon>
      Enter Vehicle Without Reservation
    </ion-button>

  </div>

  <h2 class="section-title">Pending Reservations</h2>

  <div class="search-box">
    <ion-item lines="none">
      <ion-icon name="search-outline" slot="start"></ion-icon>
      <ion-input placeholder="Search by plate..." [(ngModel)]="searchPlate" (ionInput)="filterReservations()">
      </ion-input>
    </ion-item>
  </div>

  <!-- REFRESH FLOATING BUTTON -->
  <button class="floating-refresh" (click)="refreshList()">
    <ion-icon name="refresh-outline"></ion-icon>
  </button>

  <!-- Lista de reservas -->
  <ion-list>
    <ion-item *ngFor="let res of filteredReservations" (click)="openReservationActions(res)">
      <ion-icon [name]="getVehicleIcon(res.vehicleType)" slot="start"></ion-icon>
      <ion-label>
        <h2>{{ res.plate }} — {{ res.model }}</h2>
        <p>Space: {{ res.space }} | Status: {{ res.status }}</p>
      </ion-label>
      <ion-icon name="chevron-forward-outline"></ion-icon>
    </ion-item>
  </ion-list>

  <!-- MODAL DE ACCIONES PARA RESERVA -->
  <ion-modal [isOpen]="showReservationModal" (didDismiss)="closeReservationModal()">
    <ng-template>
      <ion-header translucent>
        <ion-toolbar color="primary">
          <ion-title>Reservation Options</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeReservationModal()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">

        <div *ngIf="selectedReservation">
          <h2>{{ selectedReservation.plate }}</h2>
          <p><strong>Model:</strong> {{ selectedReservation.model }}</p>
          <p><strong>Space:</strong> {{ selectedReservation.space }}</p>
          <p><strong>Status:</strong> {{ selectedReservation.status }}</p>
        </div>

        <ion-button expand="block" color="success" (click)="ingresarReserva()">
          <ion-icon name="log-in-outline"></ion-icon>
          &nbsp; Enter Vehicle
        </ion-button>

        <ion-button expand="block" color="danger" (click)="cancelarReserva()">
          <ion-icon name="close-circle-outline"></ion-icon>
          &nbsp; Cancel Reservation
        </ion-button>

      </ion-content>

    </ng-template>
  </ion-modal>

  <!-- MODAL PARA INGRESAR VEHÍCULO SIN RESERVA -->
  <ion-modal [isOpen]="showManualEntryModal" (didDismiss)="closeManualEntryModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Manual Entry</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeManualEntryModal()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding modal-content">
        
        <!-- Vehicle Type Selector -->
        <div class="vehicle-selector">
          <button 
            class="vehicle-btn" 
            [class.active]="manualEntry.vehicleType === 'Car'"
            (click)="manualEntry.vehicleType = 'Car'">
            <ion-icon name="car"></ion-icon>
            <span>Car</span>
          </button>
          <button 
            class="vehicle-btn" 
            [class.active]="manualEntry.vehicleType === 'Motorcycle'"
            (click)="manualEntry.vehicleType = 'Motorcycle'">
            <ion-icon name="bicycle"></ion-icon>
            <span>Motorcycle</span>
          </button>
          <button 
            class="vehicle-btn" 
            [class.active]="manualEntry.vehicleType === 'Bicycle'"
            (click)="manualEntry.vehicleType = 'Bicycle'">
            <ion-icon name="bicycle-outline"></ion-icon>
            <span>Bicycle</span>
          </button>
        </div>

        <!-- Vehicle Details -->
        <ion-list>
          <ion-item>
            <ion-label position="floating">Plate</ion-label>
            <ion-input [(ngModel)]="manualEntry.plate" placeholder="Enter plate"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Model</ion-label>
            <ion-input [(ngModel)]="manualEntry.model" placeholder="Enter model"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Space</ion-label>
            <ion-input [(ngModel)]="manualEntry.spaceCode" placeholder="Select space below" readonly></ion-input>
          </ion-item>
        </ion-list>

        <!-- Available Spaces Grid -->
        <div class="spaces-section">
          <h3 class="section-subtitle">Select Available Space</h3>
          <div class="parking-grid">
            <div *ngFor="let space of availableSpaces" 
                 class="parking-slot"
                 [class.selected]="manualEntry.spaceCode === space.code"
                 (click)="selectSpace(space.code)">
              <span class="slot-number">{{ space.code }}</span>
              <span class="slot-price">{{ space.pricePerHour | currency:'COP':'symbol':'1.0-0' }}/h</span>
            </div>
          </div>
        </div>

        <ion-button expand="block" color="success" (click)="createManualEntry()">
          <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
          Confirm Entry
        </ion-button>

      </ion-content>
    </ng-template>
  </ion-modal>

  <app-admin-submenu (navigate)="go($event)"></app-admin-submenu>
</ion-content>
